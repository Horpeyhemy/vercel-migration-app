trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

stages:

# ============================
# BUILD STAGE
# ============================
- stage: Build 
  jobs:
  - job: BuildJob 
    steps:
    - checkout: self

    - task: NodeTool@0 
      inputs:
        versionSpec: '20.x'

    - script: |
        echo "Installing dependencies..."
        npm ci

        echo "Building Next.js standalone..."
        npm run build

        echo "Checking standalone output..."
        ls -R .next/standalone || echo "‚ùå Standalone folder missing"

      displayName: "Install & Build"

    - script: |
        echo "Preparing build_output..."

        rm -rf build_output
        mkdir -p build_output

        # Copy standalone server
        cp -R .next/standalone/* build_output/

        # Copy static assets
        mkdir -p build_output/.next
        cp -R .next/static build_output/.next/static

        # Copy public files
        if [ -d "public" ]; then
          cp -R public build_output/public
        fi

        echo "Contents of build_output:"
        ls -R build_output
      displayName: "Prepare Output"

    - task: ArchiveFiles@2 
      inputs:
        rootFolderOrFile: "build_output"
        includeRootFolder: false
        archiveType: zip
        archiveFile: "$(Build.ArtifactStagingDirectory)/app.zip"
        replaceExistingArchive: true
      displayName: "Zip Standalone Build"

    - publish: "$(Build.ArtifactStagingDirectory)/app.zip"
      artifact: drop
      displayName: "Publish Artifact"
 

# ============================
# DEPLOY STAGE
# ============================
- stage: Deploy
  dependsOn: Build
  jobs:
  - deployment: DeployWebApp
    environment: "dev"
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: drop

          - task: AzureWebApp@1 
            inputs:
              azureSubscription: "vercel-opeyemi"
              appName: "my-vercel-migration-app"
              package: "$(Pipeline.Workspace)/drop/app.zip"
            displayName: "Deploy App"
