trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
- group: 'vercel-migration-secrets'

stages:
# ============================================
# BUILD STAGE — produces .next/standalone
# ============================================
- stage: Build
  displayName: "Build Stage"

  jobs:
  - job: BuildJob
    displayName: "Build Next.js Standalone App"

    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '20.x'
      displayName: "Install Node.js 20"
 
    - script: |
        npm ci
        npm run build
      displayName: "Install dependencies & Build Next.js"

    # COPY standalone server output → artifact
    - task: CopyFiles@2
      displayName: "Copy standalone server output"
      inputs:
        SourceFolder: "$(Build.SourcesDirectory)/.next/standalone"
        Contents: "**"
        TargetFolder: "$(Build.ArtifactStagingDirectory)"

    # Copy public assets
    - task: CopyFiles@2
      displayName: "Copy static files"
      inputs:
        SourceFolder: "$(Build.SourcesDirectory)/.next/static"
        Contents: "**"
        TargetFolder: "$(Build.ArtifactStagingDirectory)/.next/static"

    # Copy public folder
    - task: CopyFiles@2
      displayName: "Copy public folder"
      inputs:
        SourceFolder: "$(Build.SourcesDirectory)/public"
        Contents: "**"
        TargetFolder: "$(Build.ArtifactStagingDirectory)/public"

    # Copy startup.sh into artifact root
    - task: CopyFiles@2
      displayName: "Copy startup script"
      inputs:
        SourceFolder: "$(Build.SourcesDirectory)"
        Contents: "startup.sh"
        TargetFolder: "$(Build.ArtifactStagingDirectory)"

    # Zip ONLY the standalone output
    - task: ArchiveFiles@2
      displayName: "Zip deployment package"
      inputs:
        rootFolderOrFile: "$(Build.ArtifactStagingDirectory)"
        includeRootFolder: false
        archiveType: "zip"
        archiveFile: "$(Build.ArtifactStagingDirectory)/deploy.zip"
        replaceExistingArchive: true 

    - task: PublishBuildArtifacts@1
      inputs:
        pathToPublish: "$(Build.ArtifactStagingDirectory)"
        artifactName: "drop"
      displayName: "Publish Artifact"


# ============================================
# DEPLOY STAGE — send standalone build to Azure
# ============================================
- stage: Deploy
  displayName: "Deploy to Azure"
  dependsOn: Build

  jobs:
  - deployment: DeployJob
    displayName: "Deploy Standalone Build"
    environment: "dev"

    strategy:
      runOnce:
        deploy:

          steps:
          - download: current
            artifact: drop 
 
          - task: AzureAppServiceSettings@1
            displayName: "Configure App Settings"
            inputs:
              azureSubscription: 'vercel-opeyemi'
              appName: 'ope-vercel-migration-app'
              appSettings: |
                [
                  { "name": "DATABASE_URL", "value": "$(DATABASE_URL)" },
                  { "name": "WEBSITE_RUN_FROM_PACKAGE", "value": "1" }
                ]
 
          - task: AzureWebApp@1
            displayName: "Deploy ZIP to Azure App Service"
            inputs:
              azureSubscription: 'vercel-opeyemi'
              appType: 'webAppLinux'
              appName: 'ope-vercel-migration-app'
              package: "$(Pipeline.Workspace)/drop/deploy.zip"
              runtimeStack: "NODE|20-lts"
