trigger:
  - main

pool:
  vmImage: 'ubuntu-latest'

stages:

# ==========================================================
# BUILD STAGE
# ==========================================================
- stage: Build
  displayName: "Build Next.js Standalone"
  jobs:
  - job: BuildJob
    displayName: "Build Next.js App"
    steps:

    - checkout: self

    - task: NodeTool@0
      displayName: "Install Node 20"
      inputs:
        versionSpec: '20.x'

    - script: |
        echo "=== Installing dependencies ==="
        npm ci
        echo "=== Building Next.js ==="
        npm run build
      displayName: "Install Dependencies & Build"

    # Debug: show standalone content
    - script: |
        echo "=== Show standalone folder ==="
        ls -R $(Build.SourcesDirectory)/.next/standalone || echo "Standalone NOT found"
      displayName: "DEBUG: Show Standalone Contents"

    # Prepare standalone build_output folder
    - script: |
        echo "=== Cleaning build_output ==="
        rm -rf $(Build.SourcesDirectory)/build_output
        mkdir -p $(Build.SourcesDirectory)/build_output

        echo "=== Copying standalone minimal server ==="
        cp -R $(Build.SourcesDirectory)/.next/standalone/* $(Build.SourcesDirectory)/build_output/

        echo "=== Copying static assets ==="
        mkdir -p $(Build.SourcesDirectory)/build_output/.next
        cp -R $(Build.SourcesDirectory)/.next/static $(Build.SourcesDirectory)/build_output/.next/static

        echo "=== Copying public folder ==="
        cp -R $(Build.SourcesDirectory)/public $(Build.SourcesDirectory)/build_output/public || true

        echo "=== FINAL BUILD OUTPUT STRUCTURE ==="
        ls -R $(Build.SourcesDirectory)/build_output
      displayName: "Prepare Standalone Build Output"

    - task: ArchiveFiles@2
      displayName: "Zip Standalone Build"
      inputs:
        rootFolderOrFile: "$(Build.SourcesDirectory)/build_output"
        includeRootFolder: false
        archiveType: "zip"
        archiveFile: "$(Build.ArtifactStagingDirectory)/app.zip"

    - publish: "$(Build.ArtifactStagingDirectory)/app.zip"
      displayName: "Publish Artifact"
      artifact: drop

# ==========================================================
# DEPLOY STAGE
# ==========================================================
- stage: Deploy
  dependsOn: Build
  displayName: "Deploy to Azure Web App"
  jobs:
  - deployment: DeployWebApp
    environment: "dev"
    strategy:
      runOnce:
        deploy:
          steps:

          - download: current
            artifact: drop

          - task: AzureWebApp@1 
            inputs:
              azureSubscription: "vercel-opeyemi"
              appName: "my-vercel-migration-app"
              package: "$(Pipeline.Workspace)/drop/app.zip"
            displayName: "Deploy Standalone App to Azure"
