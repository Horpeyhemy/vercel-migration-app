trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

stages:

# ==========================================================
# BUILD STAGE
# ==========================================================
- stage: Build
  displayName: "Build Next.js Standalone Output"
  jobs:
  - job: BuildJob
    displayName: "Build Next.js App"
    steps:

    - checkout: self

    # Debug: Show branch and files checked out
    - script: |
        echo "=== Current Branch and Directory ==="
        git branch
        ls -R
      displayName: "DEBUG: Validate Checkout"

    # Debug: Show Next.js config file content
    - script: |
        echo "=== next.config.js / next.config.ts contents ==="
        if [ -f next.config.js ]; then cat next.config.js; fi
        if [ -f next.config.ts ]; then cat next.config.ts; fi
      displayName: "DEBUG: Show Next Config"

    # Install Node
    - task: NodeTool@0
      displayName: "Install Node 20"
      inputs:
        versionSpec: '20.x'

    # Install dependencies & build
    - script: |
        npm ci
        npm run build
      displayName: "Build Next.js App"

    # DEBUG: Check if standalone folder was generated
    - script: |
        echo "=== Checking Next.js Build Output ==="
        ls -R .next || echo ".next folder missing"
        ls -R .next/standalone || echo ".next/standalone folder missing"
      displayName: "DEBUG: Check Standalone Build Output"

    # Prepare standalone folder for deployment
    - script: |
        mkdir -p build_output
        cp -R .next/standalone/* build_output/
        cp -R .next/static build_output/.next/static
        cp -R public build_output/public
      displayName: "Prepare Deployable Standalone Output"

    # Zip artifact
    - task: ArchiveFiles@2
      displayName: "Zip Standalone Build"
      inputs:
        rootFolderOrFile: "$(Build.SourcesDirectory)/build_output"
        includeRootFolder: false
        archiveType: zip
        archiveFile: "$(Build.ArtifactStagingDirectory)/app.zip"

    - publish: "$(Build.ArtifactStagingDirectory)/app.zip"
      displayName: "Publish Artifact"
      artifact: drop

# ==========================================================
# DEPLOY STAGE
# ==========================================================
- stage: Deploy
  dependsOn: Build
  jobs:
  - deployment: DeployWebApp
    environment: "dev"
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: drop

          - task: AzureWebApp@1
            displayName: "Deploy to Azure App Service"
            inputs:
              azureSubscription: "vercel-opeyemi"
              appName: "my-vercel-migration-app"
              package: "$(Pipeline.Workspace)/drop/app.zip"
